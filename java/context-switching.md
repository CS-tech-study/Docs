# 스레드

## Thread Mode

### Kernel Mode

#### 특징

- **운영체제의 커널이 스레드를 직접 관리**하며, 스레드의 생성, 소멸, 스케줄링 등을 처리합니다.
- 커널이 프로세스와 스레드 정보를 관리하며, 모든 TCB(Thread Control Block)와 PCB(Process Control Block)를 관리합니다.
- **시스템 자원에 대한 접근 권한**(파일 시스템, 디바이스, 메모리 등)을 갖고 있습니다.
- 커널 스레드 기반으로 **스레드와 CPU 코어의 매핑이 가능**하여 다중 코어 환경에서 병렬 처리가 가능합니다.

#### 언제 사용?

- **I/O 중심 작업이 많은 경우**: 커널 스레드는 I/O 호출 시 블로킹 상태가 되더라도 커널이 다른 스레드를 실행하도록 관리합니다.
- **다중 코어를 활용해야 하는 경우**: 커널 스레드 기반이므로 실제 CPU 코어와 병렬 처리가 가능합니다.

### User Mode

#### 특징

- 프로세스 내에 스레드 라이브러리가 존재하며, 커널에 의존하지 않고 사용자 공간에서 스레드 생성, 소멸, 스케줄링을 처리합니다.
- 커널이 아닌 사용자 공간(프로세스 안)에서 TCB를 관리합니다. (PCB는 여전히 커널에서 관리)
- 시스템 호출을 통해 직접 자원 접근은 불가하며, 시스템 자원 사용 시 커널의 개입이 필요합니다.
- 커널 모드 전환이 없기 때문에 스레드 연산 속도가 빠릅니다.

#### 언제 사용?

- I/O 작업이 적고, CPU 작업이 주가 되는 경우 사용자 모드 스레드가 효율적입니다.
- 커널 전환이 없기 때문에 성능상 이점이 있습니다.

---

# 모드 전환(이 큰 비용이 드는 이유)

### 1. 사용자 모드 → 커널 모드

#### 전환 과정 (컨텍스트 스위칭)

1. system call 호출 → CPU에서 trap 명령
2. 현재 유저 모드의 레지스터 상태와 PC를 저장
3. 커널 모드에서 필요한 컨텍스트를 로드
4. 커널 모드로 레벨 변경
5. 커널의 system call 핸들러 진입

### 2. 커널 모드 → 사용자 모드

#### 전환 과정 (컨텍스트 스위칭)

1. 커널 모드에서 저장했던 사용자 모드의 레지스터 상태를 복원
2. 사용자 모드로의 PC 복구

### 이 과정에서 발생할 수 있는 비용

#### 컨텍스트 스위칭

- 위에서 설명한 컨텍스트 스위칭 자체가 추가연산과 저장 등의 작업이 필요합니다.

#### 캐시미스

- 사용자 모드와 커널 모드는 서로 다른 메모리 영역을 사용하므로, CPU 캐시가 무효화되거나 새로 로드해야 합니다.

#### 커널 작업 처리

- 커널 작업은 공유 자원인 경우가 많기 때문에 이 과정 자체에서 I/O 작업이나 락이 걸릴 수 있습니다.

---

참고자료

https://tiptapcoding.tistory.com/entry/Window-System-Programming-Chapter-11-프로세스-vs-스레드-커널-레벨-vs-유저-레벨-스레드-커널-모드-vs-유저-모드

https://blockdmask.tistory.com/69

https://jun-n.tistory.com/156